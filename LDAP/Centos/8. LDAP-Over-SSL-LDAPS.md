# **Implementing LDAPS (LDAP over SSL/TLS)**

This guide will convert your existing LDAP setup from plain text (port 389) to the secure LDAPS protocol (port 636).

---

## **Server-Side: Certificate Generation**

### **Create Certificate Directory**

Create a dedicated directory for the SSL/TLS certificates.

```bash
mkdir -p /etc/openldap/certs
```

Navigate into the new directory.

```bash
cd /etc/openldap/certs
```

### **Generate Private Key and Certificate**

Create a self-signed certificate and private key valid for one year. The Common Name (CN) must match your server's FQDN.

```bash
openssl req -new -x509 -nodes -out ldapserver.crt -keyout ldapserver.key -days 365 -subj "/C=IN/ST=MP/L=City/O=Armour/CN=centos.armour.local"
```

### **Set Secure Permissions**

Set the correct ownership and permissions for the certificate files, ensuring the private key is protected.

```bash
chown ldap:ldap /etc/openldap/certs/*
```

```bash
chmod 600 /etc/openldap/certs/ldapserver.key
```

```bash
chmod 644 /etc/openldap/certs/ldapserver.crt
```

### **Add Certificate to System Trust Store**

Copy the new certificate to the system-wide trust store so that local applications can verify it.

```bash
cp /etc/openldap/certs/ldapserver.crt /etc/pki/ca-trust/source/anchors/
```

Update the system's CA trust index.

```bash
update-ca-trust
```

---

## **Server-Side: Configure OpenLDAP for TLS**

### **Create TLS Configuration File**

Create an LDIF file to configure OpenLDAP with the paths to the new certificate and key.

```bash
vim /root/ldif/tls-config.ldif
```

Add the following content.

```ldif
dn: cn=config
changetype: modify
add: olcTLSCACertificateFile
olcTLSCACertificateFile: /etc/openldap/certs/ldapserver.crt
-
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/openldap/certs/ldapserver.crt
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/ldapserver.key
```

### **Apply TLS Configuration**

Use `ldapmodify` to apply the TLS settings to the running `slapd` instance.

```bash
ldapmodify -Y EXTERNAL -H ldapi:/// -f /root/ldif/tls-config.ldif
```

### **Enable the LDAPS Listener**

Edit the `slapd` service configuration to listen on the secure LDAPS port.

```bash
vim /etc/sysconfig/slapd
```

Modify the `SLAPD_URLS` line to include `ldaps:///`.

```
SLAPD_URLS="ldapi:/// ldap:/// ldaps:///"
```

### **Restart and Verify the Service**

Restart the OpenLDAP service to apply all changes.

```bash
systemctl restart slapd
```

Check the service status to ensure it started without errors.

```bash
systemctl status slapd
```

Verify that the `slapd` daemon is now listening on port 636.

```bash
ss -nltp | grep 636
```

### **Configure the Firewall**

Add the `ldaps` service to the firewall rules permanently.

```bash
firewall-cmd --add-service=ldaps --permanent
```

Reload the firewall to activate the new rule.

```bash
firewall-cmd --reload
```

### **Test Local LDAPS Connection**

Perform a search query using the `ldaps://` protocol to confirm the server is working correctly.

```bash
ldapsearch -x -H ldaps://centos.armour.local -b "dc=armour,dc=local" -D "cn=admin,dc=armour,dc=local" -W
```

---

## **Server-Side: Update SSSD for LDAPS**

Update the SSSD service on the server itself so that local services like `vsftpd` can authenticate over LDAPS.

### **Update SSSD Configuration**

Edit the SSSD configuration file on the server.

```bash
vim /etc/sssd/sssd.conf
```

Modify the `[domain/armour.local]` section to use `ldaps`, changing the `ldap_uri` and certificate settings.

```ini
[domain/armour.local]
id_provider = ldap
auth_provider = ldap
ldap_uri = ldaps://centos.armour.local:636
ldap_search_base = dc=armour,dc=local
ldap_schema = rfc2307
ldap_tls_reqcert = allow
ldap_tls_cacert = /etc/openldap/certs/ldapserver.crt
ldap_id_use_start_tls = false
cache_credentials = true
enumerate = true
ldap_default_bind_dn = cn=admin,dc=armour,dc=local
ldap_default_authtok = Your_LDAP_Admin_Password
```

### **Restart SSSD**

Restart the SSSD service on the server to apply the changes.

```bash
systemctl restart sssd
```

Clear the cache to force a new, secure connection.

```bash
sssctl cache-expire -E
```

---

## **Client-Side: Update Configuration for LDAPS**

### **Copy Certificate to the Client**

From the server, securely copy the public certificate to a temporary location on the client.

```bash
scp /etc/openldap/certs/ldapserver.crt root@c1.armour.local:/tmp/
```

On the client machine, move the certificate into the system trust store.

```bash
cp /tmp/ldapserver.crt /etc/pki/ca-trust/source/anchors/
```

Update the client's CA trust index.

```bash
update-ca-trust
```

### **Update Client SSSD Configuration**

Edit the SSSD configuration file on the client.

```bash
vim /etc/sssd/sssd.conf
```

Update the `[domain/armour.local]` section to use `ldaps`, require certificate verification, and point to the CA certificate path.

```ini
[domain/armour.local]
id_provider = ldap
auth_provider = ldap
ldap_uri = ldaps://centos.armour.local:636
ldap_search_base = dc=armour,dc=local
ldap_schema = rfc2307
ldap_tls_reqcert = allow
ldap_tls_cacert = /etc/pki/ca-trust/source/anchors/ldapserver.crt
ldap_id_use_start_tls = false
cache_credentials = true
enumerate = true
ldap_default_bind_dn = cn=admin,dc=armour,dc=local
ldap_default_authtok = Your_LDAP_Admin_Password
```

### **Restart SSSD on the Client**

Restart the SSSD service to apply the new configuration.

```bash
systemctl restart sssd
```

Clear the SSSD cache to ensure a fresh connection is made using LDAPS.

```bash
sssctl cache-expire -E
```

### **Test Client Authentication**

Verify that user information can still be retrieved over the new secure connection.

```bash
getent passwd it1
```

Perform a full login test.

```bash
su - it1
```

---

## **Final Step: Disable Plaintext LDAP (Recommended)**

Once all clients and services are confirmed to be working over LDAPS, you can disable the insecure port 389 on the server.

Edit the `slapd` configuration file on the server.

```bash
vim /etc/sysconfig/slapd
```

Remove `ldap:///` from the `SLAPD_URLS` line.

```
SLAPD_URLS="ldapi:/// ldaps:///"
```

Restart the `slapd` service.

```bash
systemctl restart slapd
```
---
