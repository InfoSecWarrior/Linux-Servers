# **Configuring the OpenLDAP Directory Structure**

This guide covers the core configuration of the OpenLDAP server, including setting the administrator password, loading schemas, defining access controls, and building the directory tree for the `armour.local` domain.

---

## **Prepare the Configuration Directory**

Create a directory to store the LDIF configuration files.

```bash
mkdir /root/ldif
```

---

## **Configure the LDAP Database**

### **Generate Administrator Password**

Generate a secure, hashed password for the LDAP root administrator.

```bash
slappasswd
```

Enter your desired administrator password when prompted and copy the full output hash (e.g., `{SSHA}xxxxxxxx`).

### **Create the Database Configuration File**

Create an LDIF file to define the directory's base suffix and administrator DN.

```bash
vim /root/ldif/db-config.ldif
```

Paste the following content into the file, replacing the `olcRootPW` value with the hash you just generated.

```ldif
dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=armour,dc=local

dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=admin,dc=armour,dc=local

dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: {SSHA}your_generated_password_hash_here
```

### **Apply the Database Configuration**

Apply the changes to the running OpenLDAP service.

```bash
ldapmodify -Y EXTERNAL -H ldapi:/// -f /root/ldif/db-config.ldif
```

---

## **Load Required Schemas**

Load the essential schemas that define object classes needed for managing users and groups.

Apply the `cosine` schema.

```bash
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
```

Apply the `nis` schema (for `posixAccount` and `posixGroup`).

```bash
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif
```

Apply the `inetorgperson` schema.

```bash
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif
```

---

## **Set up Access Control Lists (ACLs)**

Create an LDIF file to define permissions for the directory.

```bash
vim /root/ldif/acl.ldif
```

Add the following ACL rules. These rules protect the `userPassword` attribute while allowing users to manage their own data.

```ldif
dn: olcDatabase={2}mdb,cn=config
changetype: modify
add: olcAccess
olcAccess: {0}to attrs=userPassword
  by self write
  by anonymous auth
  by dn="cn=admin,dc=armour,dc=local" write
  by * none
olcAccess: {1}to attrs=shadowLastChange
  by self write
  by * read
olcAccess: {2}to *
  by dn="cn=admin,dc=armour,dc=local" write
  by self read
  by * read
```

Apply the new ACL configuration.

```bash
ldapmodify -Y EXTERNAL -H ldapi:/// -f /root/ldif/acl.ldif
```

Verify the ACLs were added successfully.

```bash
ldapsearch -Y EXTERNAL -H ldapi:/// -b "olcDatabase={2}mdb,cn=config" olcAccess
```

---

## **Create the Directory Tree Structure**

### **Create the Base Domain**

Create an LDIF file for the root of your domain.

```bash
vim /root/ldif/base.ldif
```

Add the following content.

```ldif
dn: dc=armour,dc=local
objectClass: top
objectClass: dcObject
objectClass: organization
o: Armour Infosec
dc: armour
```

Add the base domain to the directory, providing the administrator password when prompted.

```bash
ldapadd -x -D "cn=admin,dc=armour,dc=local" -W -f /root/ldif/base.ldif
```

### **Create Organizational Units (OUs)**

Create an LDIF file to define the organizational structure.

```bash
vim /root/ldif/base_structure.ldif
```

Add the following OU definitions for `it`, `hr`, and `groups`.

```ldif
dn: ou=it,dc=armour,dc=local
objectClass: organizationalUnit
ou: it

dn: ou=hr,dc=armour,dc=local
objectClass: organizationalUnit
ou: hr

dn: ou=groups,dc=armour,dc=local
objectClass: organizationalUnit
ou: groups
```

Add the OUs to the directory.

```bash
ldapadd -x -D "cn=admin,dc=armour,dc=local" -W -f /root/ldif/base_structure.ldif
```

### **Create Groups**

Create an LDIF file for the POSIX groups.

```bash
vim /root/ldif/create_group.ldif
```

Add the `it` and `hr` group definitions.

```ldif
dn: cn=it,ou=groups,dc=armour,dc=local
objectClass: posixGroup
cn: it
gidNumber: 2004

dn: cn=hr,ou=groups,dc=armour,dc=local
objectClass: posixGroup
cn: hr
gidNumber: 2005
```

Add the groups to the directory.

```bash
ldapadd -x -D "cn=admin,dc=armour,dc=local" -W -f /root/ldif/create_group.ldif
```

### **Create Users**

Generate unique password hashes for each user. For example, for user `hr1` with password `Hr1@123`:

```bash
slappasswd -s 'Hr1@123'
```

Repeat this for all users to get their unique password hashes.

Create an LDIF file to add the user entries.

```bash
vim /root/ldif/add_users.ldif
```

Add the user entries, making sure to use the unique password hash for each one.

```ldif
dn: uid=hr1,ou=hr,dc=armour,dc=local
objectClass: inetOrgPerson
objectClass: posixAccount
cn: HR One
sn: One
uid: hr1
uidNumber: 3001
gidNumber: 2005
homeDirectory: /home/hr1
loginShell: /bin/bash
userPassword: {SSHA}hash_for_hr1

dn: uid=hr2,ou=hr,dc=armour,dc=local
objectClass: inetOrgPerson
objectClass: posixAccount
cn: HR Two
sn: Two
uid: hr2
uidNumber: 3002
gidNumber: 2005
homeDirectory: /home/hr2
loginShell: /bin/bash
userPassword: {SSHA}hash_for_hr2

dn: uid=it1,ou=it,dc=armour,dc=local
objectClass: inetOrgPerson
objectClass: posixAccount
cn: IT One
sn: One
uid: it1
uidNumber: 3003
gidNumber: 2004
homeDirectory: /home/it1
loginShell: /bin/bash
userPassword: {SSHA}hash_for_it1

dn: uid=it2,ou=it,dc=armour,dc=local
objectClass: inetOrgPerson
objectClass: posixAccount
cn: IT Two
sn: Two
uid: it2
uidNumber: 3004
gidNumber: 2004
homeDirectory: /home/it2
loginShell: /bin/bash
userPassword: {SSHA}hash_for_it2
```

Add the users to the directory.

```bash
ldapadd -x -D "cn=admin,dc=armour,dc=local" -W -f /root/ldif/add_users.ldif
```

### **Add Users to Groups**

Create an LDIF file to define group memberships.

```bash
vim /root/ldif/add_member_to_group.ldif
```

Add the following membership modifications for the `it` and `hr` groups.

```ldif
dn: cn=it,ou=groups,dc=armour,dc=local
changetype: modify
add: memberUid
memberUid: it1
memberUid: it2

dn: cn=hr,ou=groups,dc=armour,dc=local
changetype: modify
add: memberUid
memberUid: hr1
memberUid: hr2
```

Apply the group membership changes.

```bash
ldapmodify -x -D "cn=admin,dc=armour,dc=local" -W -f /root/ldif/add_member_to_group.ldif
```

---

## **Final Verification**

### **Test User Authentication**

Verify that an LDAP user can authenticate successfully.

```bash
ldapwhoami -x -D "uid=it1,ou=it,dc=armour,dc=local" -W
```

### **Verify Group Membership**

Search for a group to confirm its members were added.

```bash
ldapsearch -x -b "cn=it,ou=groups,dc=armour,dc=local"
```

### **View the Entire Directory**

Perform a comprehensive search to see all created entries.

```bash
ldapsearch -x -b "dc=armour,dc=local"
```

The final LDAP directory structure is as follows:

```
dc=armour,dc=local
├── ou=hr
│   ├── uid=hr1
│   └── uid=hr2
├── ou=it
│   ├── uid=it1
│   └── uid=it2
└── ou=groups
    ├── cn=hr      (members: hr1, hr2)
    └── cn=it      (members: it1, it2)
```
---
