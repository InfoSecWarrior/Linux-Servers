# **Comprehensive CentOS 9 Client Configuration**

This guide covers the complete configuration of a CentOS 9 client to integrate with a central server providing LDAP authentication, centralized NFS home directories, and FTP services.

---

## **Initial Client Setup**

### **Set Client Hostname**

Configure the client's permanent hostname.

```bash
hostnamectl set-hostname c1.armour.local
```

Verify the hostname was set correctly.

```bash
hostnamectl status
```

### **Configure DNS Resolution**

Ensure the client can resolve server hostnames by setting the system's DNS resolver.

Launch the network manager's text user interface.

```bash
nmtui
```

In the interface, edit your active connection, set the **DNS server** to `192.168.1.128` and the **search domain** to `armour.local`. After saving, reactivate the connection to apply the changes.

```bash
nmcli con down "System enp0s3" && nmcli con up "System enp0s3"
```
(Replace "System enp0s3" with the name of your active connection if different).

### **Verify DNS Resolution**

Test that the client can correctly resolve the LDAP server's hostname.

```bash
nslookup centos.armour.local
```

---

## **Core LDAP Authentication with SSSD**

### **Install Required Packages**

Install packages for SSSD, LDAP clients, and automatic home directory creation.

```bash
dnf install openldap-clients sssd sssd-ldap oddjob-mkhomedir sssd-tools -y
```

### **Configure SSSD for LDAP**

Create the SSSD configuration file to connect to the LDAP domain.

```bash
vim /etc/sssd/sssd.conf
```

Add the following configuration for an initial, unencrypted LDAP connection.

```ini
[sssd]
config_file_version = 2
services = nss, pam, sudo
domains = armour.local

[domain/armour.local]
id_provider = ldap
auth_provider = ldap
ldap_uri = ldap://centos.armour.local:389
ldap_search_base = dc=armour,dc=local
ldap_schema = rfc2307
ldap_tls_reqcert = never
ldap_auth_disable_tls_never_use_in_production = true
ldap_id_use_start_tls = false
cache_credentials = true
enumerate = true
ldap_default_bind_dn = cn=admin,dc=armour,dc=local
ldap_default_authtok = Your_LDAP_Admin_Password

[nss]
homedir_substring = /home
filter_groups = root
filter_users = root

[pam]
offline_credentials_expiration = 60

[sudo]
```

### **Set Secure Permissions**

Secure the `sssd.conf` file as it contains credentials.

```bash
chmod 600 /etc/sssd/sssd.conf
```

```bash
chown root:root /etc/sssd/sssd.conf
```

### **Enable System Authentication Services**

Switch the system's authentication profile to use SSSD and enable automatic home directory creation.

```bash
authselect select sssd with-mkhomedir --force
```

Enable and start the SSSD service.

```bash
systemctl enable sssd --now
```

Enable and start the `oddjobd` service for home directory creation.

```bash
systemctl enable oddjobd --now
```

### **Test Initial LDAP Integration**

Verify that the client can retrieve user and group information from the LDAP server.

```bash
getent passwd it1
```

```bash
getent group it
```

Test a login. This will create a *local* home directory for the user.

```bash
su - it1
```

---

## **SSH Access Configuration**

### **Edit SSH Configuration**

Open the SSH server configuration file.

```bash
vim /etc/ssh/sshd_config
```

Ensure that `UsePAM` is set to `yes`.

```
UsePAM yes
```

To limit SSH access to specific LDAP groups, uncomment and edit the `AllowGroups` line.

```
#AllowGroups it
```

### **Apply SSH Configuration**

Restart the SSH service to apply any changes.

```bash
systemctl restart sshd
```
## **Test Authentication**

### **Test Local User Switch**

Switch to an LDAP user to test the complete authentication flow.

```bash
su - it1
```

Enter the password for the `it1` user (e.g., `It1@123`) when prompted.

### **Test SSH Login**

From a different machine, attempt to SSH into the client as an LDAP user.

```bash
ssh it1@c1.armour.local
```

---

## **Configure for Centralized Home Directories (NFS)**

This section configures the client to mount home directories from the central NFS server.

### **Install Client Packages**

Install the NFS client utilities and the AutoFS service.

```bash
dnf install nfs-utils autofs -y
```

### **Remove Local Home Directories**

Remove any local home directories that were created during earlier tests to avoid conflicts.

```bash
rm -rf /home/it1 /home/hr1 /home/it2 /home/hr2
```

### **Configure AutoFS**

Edit the AutoFS master map file.

```bash
vim /etc/auto.master
```

Add the following line to tell AutoFS how to handle the `/home` directory.

```
/home   /etc/auto.home  --timeout=60
```

Next, create the specific map file for the home directories.

```bash
vim /etc/auto.home
```

Add the following line. The `*` is a wildcard that matches any user, and the `&` substitutes the username.

```
* -rw,soft,intr centos.armour.local:/home/&
```

### **Enable and Start AutoFS Service**

Enable the AutoFS service to start on boot and start it now.

```bash
systemctl enable autofs --now
```

### **Test Centralized Home Directory**

Log in as an LDAP user. AutoFS should automatically mount the home directory from the NFS server.

```bash
su - it1
```

Once logged in, create a test file to verify write access to the NFS share.

```bash
touch test-file-from-client.txt && ls
```

---

## **Configure FTP Client Access**

### **Install the FTP Client**

Install the command-line FTP client utility.

```bash
dnf install ftp -y
```

### **Test FTP Login**

Connect to the server via FTP and log in with an LDAP user's credentials.

```bash
ftp centos.armour.local
```

Once connected, test basic commands like `pwd`, `ls`, and `quit`.

---

## **Upgrade to Secure LDAPS Authentication**

This final step secures the communication between the client and the LDAP server.

### **Copy Server Certificate to the Client**

From the server, securely copy the LDAP server's public certificate to the client.

```bash
scp /etc/openldap/certs/ldapserver.crt root@c1.armour.local:/tmp/
```

On the client, move the certificate into the system's trusted anchor directory.

```bash
cp /tmp/ldapserver.crt /etc/pki/ca-trust/source/anchors/
```

Update the client's CA trust store.

```bash
update-ca-trust
```

### **Update SSSD Configuration for LDAPS**

Edit the SSSD configuration file on the client.

```bash
vim /etc/sssd/sssd.conf
```

Modify the `[domain/armour.local]` section to use `ldaps` and verify the server certificate.

```ini
[domain/armour.local]
id_provider = ldap
auth_provider = ldap
ldap_uri = ldaps://centos.armour.local:636
ldap_search_base = dc=armour,dc=local
ldap_schema = rfc2307
ldap_tls_reqcert = allow
ldap_tls_cacert = /etc/pki/ca-trust/source/anchors/ldapserver.crt
cache_credentials = true
enumerate = true
ldap_default_bind_dn = cn=admin,dc=armour,dc=local
ldap_default_authtok = Your_LDAP_Admin_Password
```

### **Restart SSSD and Test**

Restart the SSSD service to apply the secure configuration.

```bash
systemctl restart sssd
```

Clear the SSSD cache to force a new, secure connection.

```bash
sssctl cache-expire -E
```

Verify that user information is still accessible over the secure connection.

```bash
getent passwd it1
```
---
