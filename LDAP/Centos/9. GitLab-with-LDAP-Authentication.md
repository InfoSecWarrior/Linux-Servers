# **Part 1: Standard GitLab Installation with LDAP Integration**

This guide sets up GitLab with its built-in Nginx web server and configures LDAP authentication on your CentOS 9 server.

---

## **Install GitLab Prerequisites**

### **Install Required Packages**

Install packages needed for GitLab and its dependencies.

```bash
dnf install -y curl policycoreutils openssh-server perl postfix
```

### **Start and Enable Services**

Ensure the SSH service is running and enabled.

```bash
systemctl enable sshd --now
```

---

## **Add GitLab Repository and Install**

### **Add the GitLab CE Repository**

Use the official script to add the GitLab Community Edition repository.

```bash
curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | bash
```

### **Install GitLab CE**

Install the GitLab package from the new repository.

```bash
dnf install -y gitlab-ce
```

---

## **Configure DNS for GitLab**

### **Add GitLab Domain to DNS Zone**

Edit your domain's forward lookup zone file.

```bash
vim /var/named/armour.local.zone
```

Add an A record for `gitlab.armour.local`. Remember to increment the serial number.

```conf
$TTL 86400
@   IN  SOA centos.armour.local. admin.armour.local. (
        2024010102  ; Serial (incremented)
        3600        ; Refresh
        1800        ; Retry
        604800      ; Expire
        86400       ; Minimum TTL
)
    IN  NS  centos.armour.local.
    IN  A   192.168.1.128

centos      IN  A   192.168.1.128
ldap        IN  CNAME   centos
gitlab      IN  A   192.168.1.128
```

### **Restart DNS Service**

Restart the BIND service to apply the DNS changes.

```bash
systemctl restart named
```

---

## **Configure GitLab**

### **Edit the GitLab Configuration File**

Open the main GitLab configuration file.

```bash
vim /etc/gitlab/gitlab.rb
```

### **Configure External URL, SSL, and LDAP Settings**

Set the external URL and configure the paths for the SSL certificate that GitLab's Nginx will use.

```ruby
# External URL
external_url 'https://gitlab.armour.local'

# SSL Configuration for built-in Nginx
nginx['redirect_http_to_https'] = true
nginx['ssl_certificate'] = "/etc/ssl/certs/gitlab.crt"
nginx['ssl_certificate_key'] = "/etc/ssl/private/gitlab.key"

# LDAP Configuration
gitlab_rails['ldap_enabled'] = true
gitlab_rails['prevent_ldap_sign_in'] = false

gitlab_rails['ldap_servers'] = YAML.load <<-'EOS'
  main:
    label: 'LDAP'
    host: 'centos.armour.local'
    port: 389
    uid: 'uid'
    bind_dn: 'cn=admin,dc=armour,dc=local'
    password: 'Your_LDAP_Admin_Password'
    encryption: 'plain'
    verify_certificates: false
    smartcard_auth: false
    active_directory: false
    allow_username_or_email_login: false
    lowercase_usernames: false
    block_auto_created_users: false
    base: 'dc=armour,dc=local'
    user_filter: ''
    attributes:
      username: ['uid', 'userid', 'sAMAccountName']
      email: ['mail', 'email', 'userPrincipalName']
      name: 'cn'
      first_name: 'givenName'
      last_name: 'sn'
    group_base: 'ou=groups,dc=armour,dc=local'
    sync_ssh_keys: false
EOS

# Email configuration (optional)
gitlab_rails['smtp_enable'] = false
```

### **Generate SSL Certificate for GitLab**

Create the self-signed SSL certificate for the GitLab domain.

```bash
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=IN/ST=MP/L=Ujjain/O=Armour/CN=gitlab.armour.local" -keyout /etc/ssl/private/gitlab.key -out /etc/ssl/certs/gitlab.crt
```

Set the correct permissions for the new key and certificate.

```bash
chmod 600 /etc/ssl/private/gitlab.key
```

```bash
chmod 644 /etc/ssl/certs/gitlab.crt
```

---
## **Configure and Start GitLab**

### **Reconfigure GitLab**

Apply all the configuration changes you made in `gitlab.rb`.

```bash
gitlab-ctl reconfigure
```

### **Start GitLab Services**

Start all GitLab-related services.

```bash
gitlab-ctl start
```

### **Configure the Firewall**

Open the necessary ports for web access to GitLab's built-in Nginx.

```bash
firewall-cmd --permanent --add-service=http
```

```bash
firewall-cmd --permanent --add-service=https
```

Reload the firewall to apply the rules.

```bash
firewall-cmd --reload
```

---

## **Final Testing**

### **Get Initial Admin Password**

Retrieve the temporary password for the GitLab `root` user.

```bash
cat /etc/gitlab/initial_root_password
```

### **Initial GitLab Login and LDAP Test**

Navigate to `https://gitlab.armour.local`. Log in as `root`, change the password, and then log out. Finally, test logging in with an LDAP user (e.g., `it1`) to confirm the integration works.

---
---

# **Part 2: Solution for Apache & GitLab Port Conflict**

## **The Problem: Port Conflict**

A common issue arises when you try to install GitLab on a server that is already running an Apache web server for another site (e.g., `wordpress.armour.local`). Both GitLab's built-in Nginx and Apache want to use the standard web ports (80 for HTTP and 443 for HTTPS), which causes a conflict.

## **The Solution: Apache as a Reverse Proxy**

The solution is to disable GitLab's Nginx and configure your existing Apache server to act as a "reverse proxy." Apache will handle all incoming traffic and intelligently forward requests to the correct application based on the hostname.

---

## **Configure GitLab to Disable Nginx**

Edit the GitLab configuration file.

```bash
vim /etc/gitlab/gitlab.rb
```

Ensure the following lines are set to disable the built-in Nginx and listen on an internal-only address.

```ruby
# Disable GitLab's built-in nginx
nginx['enable'] = false

# Tell GitLab to use an external web server
gitlab_workhorse['listen_network'] = "tcp"
gitlab_workhorse['listen_addr'] = "127.0.0.1:8181"

# Set the external URL (this remains the same)
external_url 'https://gitlab.armour.local'
```

---

## **Configure Apache VirtualHosts**

### **Create Apache VirtualHost for GitLab**

Create a new Apache configuration file for the GitLab site.

```bash
vim /etc/httpd/conf.d/gitlab.conf
```

Add the following VirtualHost configuration to proxy requests to GitLab.

```apache
<VirtualHost 192.168.1.128:80>
    ServerName gitlab.armour.local
    ServerAlias www.gitlab.armour.local
    
    <If "%{HTTP_HOST} != 'gitlab.armour.local' && %{HTTP_HOST} != 'www.gitlab.armour.local'">
        Require all denied
    </If>
    
    Redirect permanent / https://gitlab.armour.local/
</VirtualHost>

<VirtualHost 192.168.1.128:443>
    ServerName gitlab.armour.local
    ServerAlias www.gitlab.armour.local
    
    <If "%{HTTP_HOST} != 'gitlab.armour.local' && %{HTTP_HOST} != 'www.gitlab.armour.local'">
        Require all denied
    </If>
    
    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/gitlab.crt
    SSLCertificateKeyFile /etc/pki/tls/private/gitlab.key
    
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8181/
    ProxyPassReverse / http://127.0.0.1:8181/
    
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Ssl on
    
    ErrorLog /var/log/httpd/gitlab-ssl-error.log
    CustomLog /var/log/httpd/gitlab-ssl-access.log combined
</VirtualHost>
```

### **Update Existing Apache VirtualHost (WordPress)**

Edit the configuration file for your existing WordPress site to add strict hostname checking.

```bash
vim /etc/httpd/conf.d/wordpress.conf
```

Add the `<If>` blocks to both the port 80 and 443 VirtualHosts.

```apache
<VirtualHost 192.168.1.128:80>
    ServerName wordpress.armour.local
    ServerAlias www.wordpress.armour.local
    
    # Add this block for strict hostname checking
    <If "%{HTTP_HOST} != 'wordpress.armour.local' && %{HTTP_HOST} != 'www.wordpress.armour.local'">
        Require all denied
    </If>
    
    DocumentRoot /var/www/html/wordpress/
    DirectoryIndex index.php index.html
    Redirect permanent / https://wordpress.armour.local/
</VirtualHost>

<VirtualHost 192.168.1.128:443>
    ServerName wordpress.armour.local
    ServerAlias www.wordpress.armour.local
    
    # Add this block for strict hostname checking
    <If "%{HTTP_HOST} != 'wordpress.armour.local' && %{HTTP_HOST} != 'www.wordpress.armour.local'">
        Require all denied
    </If>
    
    DocumentRoot /var/www/html/wordpress/
    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/wordpress.crt
    SSLCertificateKeyFile /etc/pki/tls/private/wordpress.key
    # ... rest of your WordPress SSL config ...
</VirtualHost>
```

---

## **Create SSL Certificates for Apache**

Generate separate self-signed certificates for Apache to use for each site.

Generate the GitLab certificate.

```bash
openssl req -new -x509 -nodes -days 365 -keyout /etc/pki/tls/private/gitlab.key -out /etc/pki/tls/certs/gitlab.crt -subj "/C=IN/ST=MP/L=City/O=Armour/CN=gitlab.armour.local"
```

Generate the WordPress certificate.

```bash
openssl req -new -x509 -nodes -days 365 -keyout /etc/pki/tls/private/wordpress.key -out /etc/pki/tls/certs/wordpress.crt -subj "/C=IN/ST=MP/L=City/O=Armour/CN=wordpress.armour.local"
```

---

## **Apply All Changes**

Reconfigure GitLab to run without Nginx.

```bash
gitlab-ctl reconfigure
```

Restart GitLab's internal services.

```bash
gitlab-ctl restart
```

Restart Apache to load the new proxy configuration.

```bash
systemctl restart httpd
```
---
---

# **Part 3: Updating GitLab to Use LDAPS**

After you have successfully configured your OpenLDAP server to use LDAPS on port 636, you must update your GitLab configuration to communicate securely.

---

## **Update GitLab Configuration for LDAPS**

Edit the main GitLab configuration file.

```bash
vim /etc/gitlab/gitlab.rb
```

Locate the `gitlab_rails['ldap_servers']` section and update it to use LDAPS.

```ruby
gitlab_rails['ldap_servers'] = YAML.load <<-'EOS'
  main:
    label: 'LDAP'
    host: 'centos.armour.local'
    port: 636                                    # Changed from 389
    uid: 'uid'
    bind_dn: 'cn=admin,dc=armour,dc=local'
    password: 'Your_LDAP_Admin_Password'
    encryption: 'simple_tls'                     # Changed from 'plain'
    verify_certificates: true                    # Changed from false
    ca_file: '/etc/openldap/certs/ldapserver.crt'  # Added - path to LDAP server's CA cert
    ssl_version: 'TLSv1_2'                       # Added - specify TLS version
    smartcard_auth: false
    active_directory: false
    allow_username_or_email_login: false
    lowercase_usernames: false
    block_auto_created_users: false
    base: 'dc=armour,dc=local'
    user_filter: ''
    attributes:
      username: ['uid', 'userid', 'sAMAccountName']
      email: ['mail', 'email', 'userPrincipalName']
      name: 'cn'
      first_name: 'givenName'
      last_name: 'sn'
    group_base: 'ou=groups,dc=armour,dc=local'
    sync_ssh_keys: false
EOS
```

---

## **Provide Certificate to GitLab**

For GitLab to trust the LDAPS connection, it needs a copy of the LDAP server's public certificate.

Copy the certificate into GitLab's trusted certificate directory.

```bash
cp /etc/openldap/certs/ldapserver.crt /etc/gitlab/trusted-certs/
```

---

## **Apply Changes and Test**

Reconfigure GitLab to apply the new LDAPS settings.

```bash
gitlab-ctl reconfigure
```

Restart the GitLab services.

```bash
gitlab-ctl restart
```

Test the new secure LDAP connection from the command line.

```bash
gitlab-rake gitlab:ldap:check
```

A successful check confirms that GitLab is now communicating with your LDAP server over a secure channel.

---
