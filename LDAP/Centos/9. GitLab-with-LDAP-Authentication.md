# **GitLab Installation with LDAP Integration on CentOS 9**

This guide sets up GitLab with LDAP authentication integration on your existing CentOS 9 server.

---

## **Install GitLab Prerequisites**

### **Install Required Packages**

Install packages needed for GitLab and its dependencies.

```bash
dnf install -y curl policycoreutils openssh-server perl postfix
```

### **Start and Enable Services**

Ensure the SSH service is running and enabled.

```bash
systemctl enable sshd --now
```

---

## **Add GitLab Repository**

### **Add the GitLab CE Repository**

Use the official script to add the GitLab Community Edition repository to your system.

```bash
curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | bash
```

### **Install GitLab CE**

Install the GitLab CE package from the newly added repository.

```bash
dnf install -y gitlab-ce
```

---

## **Configure DNS for GitLab**

### **Add GitLab Domain to DNS Zone**

Edit your domain's forward lookup zone file.

```bash
vim /var/named/armour.local.zone
```

Add an A record for `gitlab.armour.local`. Remember to increment the serial number.

```conf
$TTL 86400
@   IN  SOA centos.armour.local. admin.armour.local. (
        2024010102  ; Serial (incremented)
        3600        ; Refresh
        1800        ; Retry
        604800      ; Expire
        86400       ; Minimum TTL
)
    IN  NS  centos.armour.local.
    IN  A   192.168.1.128

centos      IN  A   192.168.1.128
ldap        IN  CNAME   centos
gitlab      IN  A   192.168.1.128
```

### **Restart DNS Service**

Restart the BIND service to apply the DNS changes.

```bash
systemctl restart named
```

### **Test DNS Resolution**

Verify that the new GitLab domain resolves correctly.

```bash
nslookup gitlab.armour.local
```

---

## **Configure GitLab**

### **Edit the GitLab Configuration File**

Open the main GitLab configuration file.

```bash
vim /etc/gitlab/gitlab.rb
```

### **Configure Basic and LDAP Settings**

Set the external URL for GitLab and configure it to connect to your LDAP server.

```ruby
# External URL
external_url 'https://gitlab.armour.local'

# SSL Configuration
nginx['redirect_http_to_https'] = true
nginx['ssl_certificate'] = "/etc/ssl/certs/gitlab.crt"
nginx['ssl_certificate_key'] = "/etc/ssl/private/gitlab.key"

# LDAP Configuration
gitlab_rails['ldap_enabled'] = true
gitlab_rails['prevent_ldap_sign_in'] = false

gitlab_rails['ldap_servers'] = YAML.load <<-'EOS'
  main:
    label: 'LDAP'
    host: 'centos.armour.local'
    port: 389
    uid: 'uid'
    bind_dn: 'cn=admin,dc=armour,dc=local'
    password: 'Your_LDAP_Admin_Password'
    encryption: 'plain'
    verify_certificates: false
    smartcard_auth: false
    active_directory: false
    allow_username_or_email_login: false
    lowercase_usernames: false
    block_auto_created_users: false
    base: 'dc=armour,dc=local'
    user_filter: ''
    attributes:
      username: ['uid', 'userid', 'sAMAccountName']
      email: ['mail', 'email', 'userPrincipalName']
      name: 'cn'
      first_name: 'givenName'
      last_name: 'sn'
    group_base: 'ou=groups,dc=armour,dc=local'
    sync_ssh_keys: false
EOS

# Email configuration (optional)
gitlab_rails['smtp_enable'] = false
```

---

## **Generate SSL Certificate for GitLab**

### **Create the SSL Certificate and Key**

Generate a self-signed certificate for the GitLab domain.

```bash
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=IN/ST=MP/L=Ujjain/O=Armour/CN=gitlab.armour.local" -keyout /etc/ssl/private/gitlab.key -out /etc/ssl/certs/gitlab.crt
```

### **Set Secure Permissions**

Set the correct permissions for the new key and certificate.

```bash
chmod 600 /etc/ssl/private/gitlab.key
```

```bash
chmod 644 /etc/ssl/certs/gitlab.crt
```

---
## **Configure and Start GitLab**

### **Reconfigure GitLab**

Apply all the configuration changes you made in `gitlab.rb`.

```bash
gitlab-ctl reconfigure
```

### **Start GitLab Services**

Start all GitLab-related services.

```bash
gitlab-ctl start
```

### **Check GitLab Status**

Verify that all services started correctly.

```bash
gitlab-ctl status
```

---

## **Configure the Firewall**

Open the necessary ports for web access to GitLab.

```bash
firewall-cmd --permanent --add-service=http
```

```bash
firewall-cmd --permanent --add-service=https
```

```bash
firewall-cmd --permanent --add-port=8080/tcp
```

Reload the firewall to apply the rules.

```bash
firewall-cmd --reload
```

---

## **Get Initial Admin Password**

Retrieve the temporary password for the GitLab `root` administrator.

```bash
cat /etc/gitlab/initial_root_password
```
**Note:** This file is automatically deleted 24 hours after the first reconfiguration.

---

## **Initial GitLab Login and LDAP Test**

### **Access the GitLab Web Interface**
Navigate to `https://gitlab.armour.local`. Log in as the `root` user with the password you just retrieved. You will be required to change it immediately.

### **Test LDAP Connection from the Command Line**

Check that GitLab can successfully connect to the LDAP server.

```bash
gitlab-rake gitlab:ldap:check
```

---

## **Test User Authentication**

### **Log out from the GitLab `root` account.**

### **Log in with LDAP credentials**
- **Username:** `it1`
- **Password:** `It1@123` (or the password you set for the user)

A successful login confirms that the LDAP integration is working correctly.

---
