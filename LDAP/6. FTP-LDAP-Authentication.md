# **Configure FTP Server (vsftpd) with LDAP Authentication**

This guide details how to set up `vsftpd` on the LDAP server (`centos.armour.local`) to allow authenticated LDAP users to access their files via FTP.

---

## **Server-Side Configuration (`centos.armour.local`)**

### **Install vsftpd**

Install the Very Secure FTP Daemon package.

```bash
dnf install vsftpd -y
```

### **Install SSSD for Local LDAP Authentication**

Install SSSD on the server itself so that services like `vsftpd` can authenticate LDAP users via PAM.

```bash
dnf install sssd sssd-ldap -y
```

### **Configure SSSD on the Server**

Create the SSSD configuration file on the server.

```bash
vim /etc/sssd/sssd.conf
```

Add the following configuration. Note the `ldap_uri` points to `localhost`.

```ini
[sssd]
config_file_version = 2
services = nss, pam
domains = armour.local

[domain/armour.local]
id_provider = ldap
auth_provider = ldap
ldap_uri = ldap://localhost
ldap_search_base = dc=armour,dc=local
ldap_schema = rfc2307
ldap_tls_reqcert = never
ldap_id_use_start_tls = false
ldap_auth_disable_tls_never_use_in_production = true
cache_credentials = true
enumerate = true
ldap_default_bind_dn = cn=admin,dc=armour,dc=local
ldap_default_authtok = Your_LDAP_Admin_Password

[nss]
homedir_substring = /home
filter_groups = root
filter_users = root

[pam]
```

### **Apply Authentication Configuration on Server**

Set the correct permissions on the SSSD configuration file.

```bash
chmod 600 /etc/sssd/sssd.conf
```

Enable and start the SSSD service.

```bash
systemctl enable sssd --now
```

Select the SSSD authentication profile for the server.

```bash
authselect select sssd with-mkhomedir --force
```

Enable the `oddjobd` service for home directory management.

```bash
systemctl enable oddjobd --now
```

### **Configure vsftpd**

Edit the main `vsftpd` configuration file.

```bash
vim /etc/vsftpd/vsftpd.conf
```

Ensure the following settings are configured to enable secure, local user access.

```conf
anonymous_enable=NO
local_enable=YES
write_enable=YES
chroot_local_user=YES
allow_writeable_chroot=YES
use_localtime=YES
xferlog_enable=YES
xferlog_std_format=YES
pam_service_name=vsftpd
ssl_enable=NO
listen=YES
listen_ipv6=NO
userlist_enable=YES
userlist_deny=NO
userlist_file=/etc/vsftpd/user_list
tcp_wrappers=NO
```

### **Create FTP User Access List**

Create a whitelist of LDAP users who are allowed to use the FTP service.

```bash
vim /etc/vsftpd/user_list
```

Add the usernames, one per line.

```
it1
it2
hr1
hr2
```

### **Create Home Directories on Server**

Create the home directories for the LDAP users.

```bash
mkdir -p /home/{it1,it2,hr1,hr2}
```

Set the correct ownership for the home directories.

```bash
for user in it1 it2 hr1 hr2; do chown $user:$user /home/$user; done
```

### **Enable and Start vsftpd Service**

Enable the FTP server to start on boot and start it now.

```bash
systemctl enable vsftpd --now
```

Check the status to ensure it is running correctly.

```bash
systemctl status vsftpd
```

### **Configure Firewall for FTP**

Add the FTP service to the firewall rules permanently.

```bash
firewall-cmd --add-service=ftp --permanent
```

Reload the firewall to apply the new rule.

```bash
firewall-cmd --reload
```

### **Configure SELinux**

If SELinux is in enforcing mode, you must allow FTP full home directory access.

```bash
setsebool -P ftpd_full_access on
```

---

## **Client-Side FTP Testing**

### **Test from a Linux Client**

From the client machine (`c1.armour.local`), connect to the FTP server.

```bash
ftp centos.armour.local
```

Log in using an allowed LDAP user's credentials (e.g., `it1` and its password).

Once connected, test basic FTP commands.

```
pwd
ls
put testfile.txt
get testfile.txt
quit
```

### **Test from a Windows Client**

Open a Command Prompt on a Windows machine on the same network.

```cmd
ftp 192.168.1.128
```

Log in with the same LDAP credentials to verify access.

---

## **Optional: Grant Sudo Access to IT Group**

To grant full administrative access to all users in the `it` group, create a new file in the sudoers directory.

```bash
vim /etc/sudoers.d/it-group
```

Add the following line to give passwordless sudo access to the `it` group.

```
%it ALL=(ALL) NOPASSWD: ALL
```
---
