# **Configure CentOS 9 Client for LDAP Authentication**

This guide covers the initial client configuration on CentOS 9 to authenticate against the LDAP server at `centos.armour.local`.

---

## **Set Client Hostname**

Configure the client's permanent hostname.

```bash
hostnamectl set-hostname c1.armour.local
```

Verify the hostname was set correctly.

```bash
hostnamectl status
```

---
## **Configure DNS Resolution**

Ensure the client can resolve the LDAP server's hostname by setting the system's DNS resolver.

Launch the network manager's text user interface to make persistent changes.

```bash
nmtui
```

In the interface, edit your active connection and set the DNS server to `192.168.1.128` and the search domain to `armour.local`. After saving, reactivate the connection to apply the changes.

```bash
nmcli con down "System enp0s3" && nmcli con up "System enp0s3"
```
(Replace "System enp0s3" with the name of your active connection if different).

---

## **Verify DNS Resolution**

Test that the client can correctly resolve the LDAP server's hostname.

```bash
nslookup centos.armour.local
```

Test network connectivity to the LDAP server.

```bash
ping -c 3 centos.armour.local
```

---

## **Install Required Packages**

Install the necessary packages for SSSD-based LDAP authentication.

### **Install SSSD and LDAP Client Packages**

```bash
dnf install openldap-clients sssd sssd-ldap oddjob-mkhomedir -y
```

### **Install SSSD Management Tools**

```bash
dnf install sssd-tools -y
```

---

## **Configure SSSD**

Create the SSSD configuration file to define the connection to the LDAP domain.

```bash
vim /etc/sssd/sssd.conf
```

Add the following configuration, replacing the placeholder password with your LDAP administrator password.

```ini
[sssd]
config_file_version = 2
services = nss, pam, sudo
domains = armour.local

[domain/armour.local]
id_provider = ldap
auth_provider = ldap
ldap_uri = ldap://centos.armour.local:389
ldap_search_base = dc=armour,dc=local
ldap_schema = rfc2307
ldap_tls_reqcert = never
ldap_auth_disable_tls_never_use_in_production = true
ldap_id_use_start_tls = false
cache_credentials = true
enumerate = true
ldap_default_bind_dn = cn=admin,dc=armour,dc=local
ldap_default_authtok = Your_LDAP_Admin_Password

[nss]
homedir_substring = /home
filter_groups = root
filter_users = root

[pam]
offline_credentials_expiration = 60

[sudo]
```

### **Set Secure Permissions**

The `sssd.conf` file contains sensitive credentials and must be secured.

```bash
chmod 600 /etc/sssd/sssd.conf
```

```bash
chown root:root /etc/sssd/sssd.conf
```

---

## **Enable System Authentication Services**

### **Configure System Authentication with `authselect`**

Switch the system's authentication profile to use SSSD and enable automatic home directory creation.

```bash
authselect select sssd with-mkhomedir --force
```

### **Enable and Start SSSD**

Enable the SSSD service to start on boot and start it now.

```bash
systemctl enable sssd --now
```

### **Enable `oddjobd` for Home Directory Creation**

Enable the `oddjobd` service, which works with PAM to create home directories for LDAP users.

```bash
systemctl enable oddjobd --now
```

---

## **Test LDAP Integration**

### **Verify User Resolution**

Check if the client can retrieve information about an LDAP user.

```bash
getent passwd it1
```

### **Verify Group Resolution**

Check if the client can retrieve information about an LDAP group.

```bash
getent group it
```

---

## **Optional SSH Access Configuration**

### **Edit SSH Configuration**

Open the SSH server configuration file.

```bash
vim /etc/ssh/sshd_config
```

Ensure that `UsePAM` is set to `yes`.

```
UsePAM yes
```

To limit SSH access to specific LDAP groups, uncomment and edit the `AllowGroups` line.

```
#AllowGroups it
```

### **Apply SSH Configuration**

Restart the SSH service to apply any changes.

```bash
systemctl restart sshd
```

---

## **Test Authentication**

### **Test Local User Switch**

Switch to an LDAP user to test the complete authentication flow.

```bash
su - it1
```

Enter the password for the `it1` user (e.g., `It1@123`) when prompted.

### **Test SSH Login**

From a different machine, attempt to SSH into the client as an LDAP user.

```bash
ssh it1@c1.armour.local
```

---

## **Troubleshooting**

### **Check SSSD Logs in Real-Time**

```bash
journalctl -u sssd -f
```

### **Clear the SSSD Cache**

If user or group information is outdated, clear the cache and restart SSSD.

```bash
systemctl stop sssd
```

```bash
rm -rf /var/lib/sss/db/*
```

```bash
rm -rf /var/lib/sss/mc/*
```

```bash
systemctl start sssd
```

### **Check Direct LDAP Connectivity**

From the client, test if you can query the LDAP server directly.

```bash
ldapsearch -x -H ldap://centos.armour.local -b "dc=armour,dc=local" "(uid=it1)"
```

### **Test User Authentication Directly with LDAP**

This command bypasses SSSD to test if the LDAP server itself can validate the user's credentials.

```bash
ldapwhoami -x -D "uid=it1,ou=it,dc=armour,dc=local" -W -H ldap://centos.armour.local
```
---
