# **Prepare CentOS 9 System for OpenLDAP Server**

This guide covers the initial system preparation and OpenLDAP installation on CentOS 9 for the domain `armour.local`.

---

## **Set System Hostname**

Configure the system hostname to a Fully Qualified Domain Name (FQDN).

```bash
hostnamectl set-hostname centos.armour.local
```

Verify the new hostname has been set correctly.

```bash
hostnamectl status
```

---

## **Configure Name Resolution**

Choose one of the following methods for name resolution. The DNS method is recommended for most environments.

### **Option A: Local Hosts File (Simple Method)**

For simple test environments, you can use the local hosts file for name resolution.

Edit the hosts file.

```bash
vim /etc/hosts
```

Add an entry mapping the server's IP to its hostname.

```
192.168.1.128   centos.armour.local centos
```

### **Option B: DNS Configuration (Recommended Method)**

Install and configure a local BIND DNS server for robust name resolution.

#### **Install BIND**

Install the BIND DNS server and utility packages.

```bash
dnf install bind bind-utils -y
```

#### **Configure BIND Options**

Edit the main BIND configuration file.

```bash
vim /etc/named.conf
```

In the `options` block, configure BIND to listen on the server's IP and allow queries from the local network.

```conf
options {
    listen-on port 53 { 127.0.0.1; 192.168.1.128; };
    allow-query { localhost; 192.168.1.0/24; };
    forwarders { 8.8.8.8; 8.8.4.4; };
    /* --- other options remain as default --- */
};
```

#### **Define DNS Zones**

Edit the standard zone file to add your new forward and reverse zones.

```bash
vim /etc/named.rfc1912.zones
```

Add the following zone definitions to the end of the file.

```conf
zone "armour.local" IN {
    type master;
    file "armour.local.zone";
    allow-update { none; };
};

zone "1.168.192.in-addr.arpa" IN {
    type master;
    file "1.168.192.rev";
    allow-update { none; };
};
```

#### **Create Forward Zone File**

Create the zone file for forward lookups (name to IP).

```bash
vim /var/named/armour.local.zone
```

Add the following records.

```conf
$TTL 86400
@   IN  SOA centos.armour.local. admin.armour.local. (
        2024010101  ; Serial
        3600        ; Refresh
        1800        ; Retry
        604800      ; Expire
        86400       ; Minimum TTL
)
    IN  NS  centos.armour.local.
    IN  A   192.168.1.128

centos  IN  A   192.168.1.128
ldap    IN  CNAME   centos
```

#### **Create Reverse Zone File**

Create the zone file for reverse lookups (IP to name).

```bash
vim /var/named/1.168.192.rev
```

Add the following records.

```conf
$TTL 86400
@   IN  SOA centos.armour.local. admin.armour.local. (
        2024010101  ; Serial
        3600        ; Refresh
        1800        ; Retry
        604800      ; Expire
        86400       ; Minimum TTL
)
    IN  NS  centos.armour.local.

128  IN  PTR centos.armour.local.
```

#### **Start and Enable DNS Service**

Enable the BIND service to start on boot and start it now.

```bash
systemctl enable named --now
```

Add the DNS service to the firewall rules permanently.

```bash
firewall-cmd --add-service=dns --permanent
```

Reload the firewall to apply the new rule.

```bash
firewall-cmd --reload
```

#### **Update System to Use Local DNS**

Use the network manager TUI to set the system's DNS resolver to itself.

```bash
nmtui
```

Navigate to "Edit a connection," select your active interface, and set the "DNS servers" field to `192.168.1.128`. Save and exit.

### **Verify Name Resolution**

Test the forward lookup.

```bash
dig centos.armour.local
```

Test the reverse lookup.

```bash
dig -x 192.168.1.128
```

Test connectivity using the hostname.

```bash
ping -c 2 centos.armour.local
```

---

## **Configure Required Repositories**

### **Enable EPEL Repository**

Install the Extra Packages for Enterprise Linux (EPEL) repository.

```bash
dnf install epel-release -y
```

### **Enable CRB Repository**

Enable the CodeReady Builder (CRB) repository for additional dependencies.

```bash
dnf config-manager --set-enabled crb
```

### **Update Repository Cache**

Refresh the system's package metadata cache.

```bash
dnf makecache
```

Verify that the required repositories are enabled.

```bash
dnf repolist
```

---

## **Install OpenLDAP Packages**

Install the core OpenLDAP server and client packages.

```bash
dnf install openldap-servers openldap-clients -y
```

Install supplementary tools for development and compatibility.

```bash
dnf install openldap-devel compat-openldap -y
```

Optionally, install tools for migrating existing system accounts to LDAP.

```bash
dnf install migrationtools -y
```

Verify the OpenLDAP packages were installed successfully.

```bash
rpm -qa | grep openldap
```

---

## **Enable and Start LDAP Service**

Enable the `slapd` service to start on boot and launch it immediately.

```bash
systemctl enable slapd --now
```

---

## **Verify Service Status**

Check that the LDAP server is active and running.

```bash
systemctl status slapd
```

If the service fails, examine the system journal for detailed error messages.

```bash
journalctl -xeu slapd
```

---

## **Configure Firewall Rules**

Open the standard ports for LDAP and LDAPS traffic.

```bash
firewall-cmd --add-service=ldap --permanent
```

```bash
firewall-cmd --add-service=ldaps --permanent
```

Reload the firewall to apply the new rules.

```bash
firewall-cmd --reload
```

Verify that the services have been added to the firewall configuration.

```bash
firewall-cmd --list-services
```

---

## **Verify LDAP Port Bindings**

Confirm that the `slapd` process is listening on the standard LDAP port.

```bash
ss -tulpn | grep slapd
```

---

## **Test Basic LDAP Connectivity**

Perform an anonymous search against the root of the server to confirm it is responsive.

```bash
ldapsearch -x -H ldap://localhost -b "" -s base
```

Perform the same test using the server's hostname.

```bash
ldapsearch -x -H ldap://centos.armour.local -b "" -s base
```

---
